# utils.py
import ipaddress
import socket

MAX_HOSTS = 1024

def validate_ip(ip_str):
    try:
        ipaddress.ip_address(ip_str)
        return True
    except ValueError:
        return False

def validate_cidr(cidr_str):
    try:
        ipaddress.ip_network(cidr_str, strict=False)
        return True
    except ValueError:
        return False

def validate_range(start_ip, end_ip):
    try:
        start = ipaddress.ip_address(start_ip)
        end = ipaddress.ip_address(end_ip)
        return start <= end
    except ValueError:
        return False

def list_from_range(start_ip, end_ip, limit=MAX_HOSTS):
    start = int(ipaddress.ip_address(start_ip))
    end = int(ipaddress.ip_address(end_ip))
    size = end - start + 1
    if size > limit:
        raise ValueError(f"Aralık {size} host içeriyor (> {limit}). Lütfen daraltın.")
    return [str(ipaddress.ip_address(i)) for i in range(start, end + 1)]

def list_from_cidr(cidr, limit=MAX_HOSTS):
    net = ipaddress.ip_network(cidr, strict=False)
    hosts = list(net.hosts()) if net.num_addresses > 2 else list(net)
    if len(hosts) > limit:
        raise ValueError(f"CIDR {len(hosts)} host içeriyor (> {limit}). Lütfen daraltın.")
    return [str(h) for h in hosts]

def resolve_domain(domain):
    try:
        infos = socket.getaddrinfo(domain, None, family=socket.AF_INET, type=socket.SOCK_STREAM)
        ips = sorted(set([item[4][0] for item in infos]))
        return ips
    except socket.gaierror as e:
        print(f"[HATA] DNS çözümlenemedi: {e}")
        return []

def compute_percentiles(values, ps=(50, 95)):
    if not values:
        return {p: None for p in ps}
    vals = sorted(values)
    out = {}
    for p in ps:
        if len(vals) == 1:
            out[p] = vals[0]
            continue
        k = (p / 100) * (len(vals) - 1)
        f = int(k)
        c = min(f + 1, len(vals) - 1)
        if f == c:
            out[p] = vals[f]
        else:
            out[p] = vals[f] + (vals[c] - vals[f]) * (k - f)
    return out
