# report.py
from datetime import datetime
import os, json

def _now(): 
    return datetime.now().strftime("%Y-%m-%d %H:%M:%S")

def _hping3_summary(raw: str):
    if not raw:
        return "Unknown"
    s = raw.lower()
    if "flags=sa" in s or " sa," in s:
        return "Open (SYN-ACK)"
    if "flags=ra" in s or " ra," in s:
        return "Closed (RST)"
    return "Unknown"

def _vegeta_one_line(txt: str):
    if not txt:
        return None
    for line in txt.splitlines():
        line = line.strip()
        if line.startswith("Requests"):
            return line
    first = txt.splitlines()[0] if "\n" in txt else txt
    return (first[:120] + "...") if len(first) > 120 else first

def generate_report(results, formats, outdir=None):
    fmts = [f.strip().upper() for f in (formats or []) if f and f.strip()]
    if not fmts:
        fmts = ["TXT"]  # boşsa TXT varsayılan

    outdir = outdir or os.path.expanduser("~/pentest_report")
    os.makedirs(outdir, exist_ok=True)
    stamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    base = os.path.join(outdir, f"pentest_report_{stamp}")  # mevcut isim şeman aynen kalsın
    outpaths = []

    # -------- TXT (insan-okur özet) --------
    if "TXT" in fmts:
        lines = []
        lines.append(f"=== Pentest Raporu — {_now()} ===\n")

        targets = results.get("targets", [])
        lines.append("[Hedefler]")
        lines.append("  " + (", ".join(targets) if targets else "(yok)"))
        lines.append("")

        for ip in targets:
            lines.append(f"== {ip}")

            # L3 özet
            l3 = results.get("L3", {}).get(ip, {})
            ic = l3.get("icmp", {}) if isinstance(l3, dict) else {}
            loss = ic.get("packet_loss_percent")
            p50  = ic.get("rtt_ms_p50")
            p95  = ic.get("rtt_ms_p95")
            n    = ic.get("rtt_samples_count")
            lines.append(f"  [L3] ICMP: loss={loss}%  p50={p50}ms  p95={p95}ms  samples={n}")

            if isinstance(l3, dict) and "traceroute" in l3:
                tro = (l3["traceroute"].get("raw_output") or "")
                hops = sum(1 for ln in tro.splitlines() if ln.strip())
                lines.append(f"      traceroute: ~{hops} hop")

            if isinstance(l3, dict) and "hping3" in l3:
                hp = l3["hping3"]
                port = hp.get("port")
                summ = _hping3_summary(hp.get("raw_output"))
                lines.append(f"      hping3 SYN: port {port} → {summ}")

            # L7 özet
            l7 = results.get("L7", {}).get(ip, {})
            ports = l7.get("ports", [])
            if ports:
                port_s = ", ".join(f"{it.get('port')}/{it.get('scheme')}:{it.get('http_code')}" for it in ports)
                lines.append(f"  [L7] ports: {port_s}")
            else:
                lines.append("  [L7] ports: -")

            # URL başlıkları ve notlar
            for key, val in l7.items():
                if key == "ports":
                    continue
                lines.append(f"      {key}")
                missing = val.get("missing", [])
                notes   = val.get("notes", [])
                lines.append(f"        missing: {', '.join(missing) if missing else '-'}")
                if notes:
                    lines.append(f"        notes: {'; '.join(notes)}")
                veg = val.get("vegeta")
                if veg:
                    v1 = _vegeta_one_line(veg)
                    if v1:
                        lines.append(f"        vegeta: {v1}")

            lines.append("")

        txt_path = f"{base}.txt"
        with open(txt_path, "w", encoding="utf-8") as f:
            f.write("\n".join(lines))
        outpaths.append(txt_path)

    # -------- JSON (ham veri) --------
    if "JSON" in fmts:
        json_path = f"{base}.json"
        with open(json_path, "w", encoding="utf-8") as f:
            json.dump(results, f, ensure_ascii=False, indent=2)
        outpaths.append(json_path)

    return outpaths
