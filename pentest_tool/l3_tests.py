# l3_tests.py
import subprocess
import re
from utils import compute_percentiles

PING_TIME_RE = re.compile(r"time[=<]([0-9]*\.?[0-9]+)\s*ms", re.IGNORECASE)
LOSS_RE = re.compile(r"(\d+(\.\d+)?)%\s*packet loss", re.IGNORECASE)

def run_icmp_test(ip, count=10, timeout_sec=20):
    cmd = ["ping", "-n", "-c", str(count), "-W", "2", ip]
    try:
        proc = subprocess.run(cmd, capture_output=True, text=True, timeout=timeout_sec)
    except Exception as e:
        return {"ip": ip, "error": str(e)}

    out = proc.stdout + "\n" + proc.stderr
    loss = None
    m_loss = LOSS_RE.search(out)
    if m_loss:
        loss = float(m_loss.group(1))

    rtts = [float(m.group(1)) for m in PING_TIME_RE.finditer(out)]
    pct = compute_percentiles(rtts, ps=(50, 95))
    return {
        "ip": ip,
        "packet_loss_percent": loss,
        "rtt_samples_count": len(rtts),
        "rtt_ms_p50": pct[50],
        "rtt_ms_p95": pct[95],
        "raw_output": out.strip()
    }

def run_traceroute(ip, max_hops=20):
    cmd = ["traceroute", "-n", "-m", str(max_hops), ip]
    try:
        proc = subprocess.run(cmd, capture_output=True, text=True, timeout=60)
        return {"ip": ip, "raw_output": proc.stdout.strip()}
    except Exception as e:
        return {"ip": ip, "error": str(e)}

def run_hping3_syn(ip, port, count=3):
    cmd = ["hping3", "-S", "-p", str(port), "-c", str(count), ip]
    try:
        proc = subprocess.run(cmd, capture_output=True, text=True, timeout=30)
        return {"ip": ip, "port": port, "raw_output": proc.stdout.strip()}
    except Exception as e:
        return {"ip": ip, "port": port, "error": str(e)}
