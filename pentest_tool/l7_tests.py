# l7_tests.py
import subprocess

CANDIDATE_WEB_PORTS = [80, 443, 8080, 8443, 8000, 3000]
SEC_HEADERS = [
    "strict-transport-security", "content-security-policy",
    "x-frame-options", "x-content-type-options",
    "referrer-policy", "permissions-policy"
]
COOKIE_FLAGS = ["httponly", "secure", "samesite"]

def guess_scheme(port):
    return "https" if port in (443, 8443) else "http"

def curl_http_code(url):
    cmd = ["curl", "-k", "-sS", "-o", "/dev/null", "-w", "%{http_code}", "--max-time", "5", url]
    try:
        proc = subprocess.run(cmd, capture_output=True, text=True, timeout=7)
        code_text = proc.stdout.strip()
        return int(code_text) if code_text.isdigit() else None
    except Exception:
        return None

def discover_web_ports(ip_or_host, candidate_ports=CANDIDATE_WEB_PORTS):
    found = []
    for port in candidate_ports:
        scheme = guess_scheme(port)
        url = f"{scheme}://{ip_or_host}:{port}/"
        code = curl_http_code(url)
        if code and 100 <= code <= 599:
            found.append({"port": port, "scheme": scheme, "url": url, "http_code": code})
    return found

def curl_headers(url):
    cmd = ["curl", "-k", "-sS", "-D", "-", "-o", "/dev/null", "--max-time", "5", url]
    try:
        proc = subprocess.run(cmd, capture_output=True, text=True, timeout=7)
        raw = proc.stdout
    except Exception as e:
        return {"_error": str(e)}

    headers = {}
    blocks = raw.strip().split("\r\n\r\n")
    last = blocks[-1] if blocks else raw
    for line in last.splitlines():
        if ":" in line:
            name, value = line.split(":", 1)
            headers[name.strip().lower()] = value.strip()
    return headers

def analyze_headers(headers):
    result = {"present": [], "missing": [], "notes": []}
    for h in SEC_HEADERS:
        if h in headers:
            result["present"].append(h)
        else:
            result["missing"].append(h)
    if "server" in headers:
        result["notes"].append(f"Server: {headers['server']}")
    # Optional: analyze cookies for flags (simple check)
    sc = headers.get("set-cookie")
    if sc:
        low = sc.lower()
        for flag in COOKIE_FLAGS:
            if flag in low:
                result["notes"].append(f"Cookie flag present: {flag}")
    return result

def run_vegeta(url, rate, duration):
    cmd_attack = f'echo "GET {url}" | vegeta attack -rate={rate} -duration={duration}'
    cmd_report = "vegeta report"
    try:
        attack_proc = subprocess.Popen(cmd_attack, shell=True, stdout=subprocess.PIPE)
        report_proc = subprocess.run(cmd_report, shell=True, stdin=attack_proc.stdout, capture_output=True, text=True)
        return report_proc.stdout.strip()
    except Exception as e:
        return f"[HATA] Vegeta çalıştırılamadı: {e}"
