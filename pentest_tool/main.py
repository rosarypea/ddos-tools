
# main.py
"""
Pentest Tool v1.0 - Ana akış
- Hedef girdisini alır (Domain/URL, tek IP, IP aralığı, CIDR).
- Seçilen katmana (L3/L7) göre testleri çalıştırır.
- Sonuçları JSON/TXT raporlarına yazar.
- Tüm sorularda B=geri, Q=çıkış desteği vardır.
"""

from utils import (
    validate_ip,
    validate_cidr,
    validate_range,
    list_from_range,
    list_from_cidr,
    resolve_domain,
)
from l3_tests import run_icmp_test, run_traceroute, run_hping3_syn
from l7_tests import discover_web_ports, curl_headers, analyze_headers, run_vegeta
from report import generate_report
import argparse
import json
import os
import re


# === Yardımcı giriş fonksiyonları (B/Q destekli) ===

def _is_bq(ans: str):
    if not ans:
        return None
    a = ans.strip().lower()
    return a if a in ("b", "q") else None


def ask_yes_no_bq(msg, default=None):
    suffix = " [E/H, B=geri, Q=çıkış]: "
    while True:
        ans = input(msg + suffix).strip().lower()
        bq = _is_bq(ans)
        if bq: return bq
        if ans == "" and default in ("e", "h"): return default
        if ans in ("e", "h"): return ans
        print("Geçersiz giriş. E/H (veya B/Q) girin.")


def ask_menu_bq(msg, valid_options):
    suffix = " [B=geri, Q=çıkış]: "
    valid_set = set(valid_options)
    while True:
        ans = input(msg + suffix).strip().lower()
        bq = _is_bq(ans)
        if bq: return bq
        if ans in valid_set: return ans
        print(f"Geçersiz giriş. Seçenekler: {', '.join(sorted(valid_set))}.")


def ask_text_bq(msg, validator=None, allow_empty=False):
    suffix = " [B=geri, Q=çıkış]: "
    while True:
        ans = input(msg + suffix)
        bq = _is_bq(ans)
        if bq: return bq
        if ans == "" and allow_empty: return ans
        if validator is None or validator(ans): return ans
        print("Geçersiz giriş, tekrar deneyin.")


def ask_multiindex_bq(msg, max_index):
    suffix = " [B=geri, Q=çıkış]: "
    while True:
        raw = input(msg + suffix).strip().lower()
        bq = _is_bq(raw)
        if bq: return bq
        if not raw: return []
        chosen, invalid = set(), []
        for token in raw.split(","):
            token = token.strip()
            if "-" in token:
                try:
                    a, b = token.split("-", 1)
                    lo, hi = sorted((int(a), int(b)))
                    for i in range(lo, hi + 1):
                        if 1 <= i <= max_index: chosen.add(i)
                except ValueError:
                    invalid.append(token)
            else:
                try:
                    i = int(token)
                    if 1 <= i <= max_index: chosen.add(i)
                    else: invalid.append(token)
                except ValueError:
                    invalid.append(token)
        if invalid:
            print(f"Uyarı: Geçersiz seçimler yoksayıldı: {', '.join(invalid)}")
        return sorted(chosen)


parser = argparse.ArgumentParser()
parser.add_argument("--auto", action="store_true", help="Prompt sormadan koş")
parser.add_argument("--config", type=str, default=None, help="run.json yolu")
args = parser.parse_args()


def load_config(path):
    with open(path, "r", encoding="utf-8") as f:
        return json.load(f)


def main():
    AUTOMODE, cfg = False, None

    # === AUTO mod ===
    if os.getenv("NONINTERACTIVE") == "1":
        AUTOMODE, cfg_path = True, os.getenv("CONFIG_PATH") or "run.json"
        cfg = load_config(cfg_path)
    elif args.auto and args.config:
        AUTOMODE, cfg = True, load_config(args.config)

    if AUTOMODE:
        targets = cfg.get("targets", [])
        run_l3, run_l7 = bool(cfg.get("run_l3", True)), bool(cfg.get("run_l7", True))
        results = {"targets": targets, "l3": [], "l7": []}

        if run_l3:
            do_traceroute = bool(cfg.get("l3_traceroute", True))
            do_hping3, hping3_port = bool(cfg.get("l3_hping3", False)), str(cfg.get("hping3_port", "80"))
            for t in targets:
                rec = {"target": t, "icmp": run_icmp_test(t)}
                if do_traceroute: rec["traceroute"] = run_traceroute(t)
                if do_hping3: rec["hping3"] = run_hping3_syn(t, hping3_port)
                results["l3"].append(rec)

        if run_l7:
            header_analysis = bool(cfg.get("header_analysis", True))
            auto_vegeta = bool(cfg.get("l7_vegeta", False))
            veg_rate, veg_dur = str(cfg.get("vegeta_rate", "50")), str(cfg.get("vegeta_duration", "30s"))
            for url in targets:
                rec = {"url": url}
                if header_analysis:
                    rec["raw_headers"] = curl_headers(url)
                    rec["header_findings"] = analyze_headers(rec["raw_headers"])
                if auto_vegeta:
                    rec["vegeta"] = run_vegeta(url, veg_rate, veg_dur)
                results["l7"].append(rec)

        formats = cfg.get("formats", ["TXT"])
        report_dir = cfg.get("report_dir", ".")
        try:
            outpaths = generate_report(results, formats, outdir=report_dir)
        except TypeError:
            outpaths = generate_report(results, formats)
        for p in outpaths: print(f"[+] Rapor: {p}")
        return

    # === INTERAKTİF mod ===
    while True:
        print("=== Pentest Tool v1.0 ===")
        print("1) Domain/URL\n2) Tek IP\n3) IP Aralığı\n4) CIDR")

        target_type = ask_menu_bq("Seçim", ("1", "2", "3", "4"))
        if target_type in ("q", None): return
        if target_type == "b": continue

        targets = []

        # --- Hedef seçimi ---
        if target_type == "1":
            domain = ask_text_bq("Domain veya URL")
            if domain in ("b", "q"): 
                if domain == "q": return
                continue
            domain = domain.strip()
            if "://" in domain: domain = domain.split("://", 1)[1].split("/")[0]
            ips = resolve_domain(domain)
            if not ips: 
                print("[HATA] DNS çözümlenemedi."); continue
            if len(ips) > 1:
                ans = ask_yes_no_bq(f"Birden fazla IP bulundu {ips}. Hepsi test edilsin mi?", default="e")
                if ans == "q": return
                if ans == "b": continue
                if ans == "e": targets = ips
                else:
                    print("IP seçin (örn: 1,3-5):")
                    for i, ip_ in enumerate(ips, 1): print(f"  {i}) {ip_}")
                    sel = ask_multiindex_bq("Seçim", len(ips))
                    if sel == "q": return
                    if sel == "b": continue
                    targets = [ips[i - 1] for i in sel] or [ips[0]]
            else:
                targets = [ips[0]]

        elif target_type == "2":
            while True:
                ip = ask_text_bq("IP")
                if ip in ("b", "q"): 
                    if ip == "q": return
                    break
                if validate_ip(ip.strip()):
                    targets = [ip.strip()]; break
                print("[HATA] Geçersiz IP.")
            if not targets: continue

        elif target_type == "3":
            while True:
                s = ask_text_bq("Başlangıç IP")
                if s in ("b", "q"): 
                    if s == "q": return
                    break
                e = ask_text_bq("Bitiş IP")
                if e in ("b", "q"): 
                    if e == "q": return
                    break
                if validate_range(s.strip(), e.strip()):
                    targets = list_from_range(s.strip(), e.strip()); break
                print("[HATA] Geçersiz aralık.")
            if not targets: continue

        elif target_type == "4":
            while True:
                cidr = ask_text_bq("CIDR (örn: 192.168.1.0/24)")
                if cidr in ("b", "q"):
                    if cidr == "q": return
                    break
                if validate_cidr(cidr.strip()):
                    targets = list_from_cidr(cidr.strip()); break
                print("[HATA] Geçersiz CIDR.")
            if not targets: continue

        # --- Katman seçimi ---
        print("Katman seçin:\n1) L3\n2) L7\n3) TEST'EM ALL")
        choice = ask_menu_bq("Seçim", ("1", "2", "3"))
        if choice == "q": return
        if choice == "b": continue

        results = {"targets": targets, "L3": {}, "L7": {}}

        discovered = {}
        if choice in ["2", "3"]:
            for t in targets:
                discovered[t] = discover_web_ports(t)
                results["L7"][t] = {"ports": discovered[t]}

        if choice in ["1", "3"]:
            for t in targets:
                results["L3"][t] = {}
                print(f"[L3] Ping: {t}")
                results["L3"][t]["icmp"] = run_icmp_test(t)

                ans = ask_yes_no_bq(f"{t} için traceroute?", default="e")
                if ans == "q": return
                if ans == "e": results["L3"][t]["traceroute"] = run_traceroute(t)

                ans = ask_yes_no_bq(f"{t} için hping3 SYN testi?", default="h")
                if ans == "q": return
                if ans == "e":
                    ports = {"80": "HTTP", "443": "HTTPS", "22": "SSH", "53": "DNS"}
                    for p, desc in ports.items(): print(f"{p} → {desc}")
                    sel = input("Port [B/Q]: ").strip().lower()
                    bq = _is_bq(sel)
                    if bq == "q": return
                    if bq != "b":
                        port = sel if sel in ports else "80"
                        results["L3"][t]["hping3"] = run_hping3_syn(t, port)

        if choice in ["2", "3"]:
            for t in targets:
                for p in discovered.get(t, []):
                    url = p["url"]
                    print(f"[L7] Headers: {url}")
                    hdrs = curl_headers(url)
                    results["L7"][t][url] = analyze_headers(hdrs)
                    ans = ask_yes_no_bq(f"{url} için Vegeta testi?", default="h")
                    if ans == "q": return
                    if ans == "e":
                        while True:
                            rate = ask_text_bq("  Rate (örn 50)")
                            if rate in ("b", "q"):
                                if rate == "q": return
                                rate = None; break
                            if rate.isdigit() and int(rate) > 0: break
                            print("Geçersiz rate.")
                        if rate:
                            while True:
                                dur = ask_text_bq("  Süre (örn 10s/2m)")
                                if dur in ("b", "q"):
                                    if dur == "q": return
                                    dur = None; break
                                if re.fullmatch(r"\d+(s|m|h)", dur.strip().lower()):
                                    dur = dur.strip().lower(); break
                                print("Geçersiz süre.")
                            if dur: results["L7"][t][url]["vegeta"] = run_vegeta(url, rate, dur)

        # --- Rapor üretimi ---
        print("Rapor formatları:\n1 → JSON\n2 → TXT")
        raw = input("Seçim(ler) [B/Q]: ").strip().lower()
        bq = _is_bq(raw)
        if bq == "q": return
        if bq == "b": continue
        mapping = {"1": "JSON", "2": "TXT"}
        formats = [mapping.get(c.strip()) for c in raw.split(",") if c.strip() in mapping]
        formats = formats or ["TXT"]

        outpaths = generate_report(results, formats, outdir=".")
        for p in outpaths: print(f"[+] Rapor kaydedildi: {p}")
        return


if __name__ == "__main__":
    main()
